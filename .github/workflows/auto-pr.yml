name: Auto PR on Successful CI

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - 'feat/**'
      - 'fix/**'
      - 'chore/**'
      - 'docs/**'
      - 'refactor/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    name: Create PR to main
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch != 'main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Create PR to main
        uses: diillson/auto-pull-request@v1.0.1
        with:
          source_branch: ${{ github.event.workflow_run.head_branch }}
          destination_branch: "main"
          pr_title: "ci: open PR for ${{ github.event.workflow_run.head_branch }}"
          pr_body: |
            This PR was automatically created after CI checks passed on branch `${{ github.event.workflow_run.head_branch }}`.

            **CI Run:** [#${{ github.event.workflow_run.run_number }}](${{ github.event.workflow_run.html_url }})

            - Lint: ✅ passed
            - Typecheck: ✅ passed
            - Build: ✅ passed

            Please review and squash-merge when ready.
          github_token: ${{ secrets.GITHUB_TOKEN }}
