name: Auto PR on Successful CI

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    # Note: Don't filter by branches here because workflow_run always reports main as head_branch
    # Instead, we filter in the job-level 'if' condition using github.event.workflow_run.head_branch
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  create-pr:
    name: Create PR to main
    runs-on: ubuntu-latest
    # Only run if CI succeeded AND the branch is not main
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch != 'main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug workflow_run context
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/auto-pr/debug-workflow-run.js');
            await script({ core, context });
      
      - name: Check for open CI failure issues
        id: check-issues
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/auto-pr/check-ci-issues.js');
            await script({ github, context, core });

      - name: Checkout branch
        if: steps.check-issues.outputs.has_issues == 'false'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Create PR to main
        if: steps.check-issues.outputs.has_issues == 'false'
        uses: diillson/auto-pull-request@v1.0.1
        with:
          source_branch: ${{ github.event.workflow_run.head_branch }}
          destination_branch: "main"
          pr_title: "ci: open PR for ${{ github.event.workflow_run.head_branch }}"
          pr_body: |
            This PR was automatically created after CI checks passed on branch `${{ github.event.workflow_run.head_branch }}`.

            **CI Run:** [#${{ github.event.workflow_run.run_number }}](${{ github.event.workflow_run.html_url }})

            - Lint: ✅ passed
            - Typecheck: ✅ passed
            - Build: ✅ passed

            Please review and squash-merge when ready.
          github_token: ${{ secrets.GITHUB_TOKEN }}
