name: Auto PR on Successful CI

on:
  workflow_run:
    workflows: ["Create Issues on CI Failure"]
    types:
      - completed
    # Note: Don't filter by branches here because workflow_run always reports main as head_branch
    # Instead, we filter in the job-level 'if' condition using github.event.workflow_run.head_branch
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  create-pr:
    name: Create PR to main
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Debug workflow_run context
        uses: actions/github-script@v7
        with:
          script: |
            core.info(`head_branch: ${context.payload.workflow_run.head_branch}`);
            core.info(`head_repository.full_name: ${context.payload.workflow_run.head_repository.full_name}`);
            core.info(`Event: ${JSON.stringify(context.payload.workflow_run, null, 2)}`);
      
      - name: Check for open CI failure issues
        id: check-issues
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.workflow_run.head_branch;
            
            // Skip if branch is main
            if (branch === 'main') {
              core.setOutput('should_skip', 'true');
              core.info(`Skipping PR creation for main branch`);
              return;
            }
            core.setOutput('should_skip', 'false');
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
              per_page: 100
            });
            
            const branchIssue = issues.data.find(issue => 
              issue.title.includes(branch) || issue.body.includes(branch)
            );
            
            if (branchIssue) {
              core.setOutput('has_issues', 'true');
              core.info(`Found open CI issue #${branchIssue.number} for branch ${branch}`);
            } else {
              core.setOutput('has_issues', 'false');
              core.info(`No open CI issues for branch ${branch}`);
            }

      - name: Checkout
        if: steps.check-issues.outputs.should_skip == 'false' && steps.check-issues.outputs.has_issues == 'false'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Create PR to main
        if: steps.check-issues.outputs.should_skip == 'false' && steps.check-issues.outputs.has_issues == 'false'
        uses: diillson/auto-pull-request@v1.0.1
        with:
          source_branch: ${{ github.event.workflow_run.head_branch }}
          destination_branch: "main"
          pr_title: "ci: open PR for ${{ github.event.workflow_run.head_branch }}"
          pr_body: |
            This PR was automatically created after CI checks passed on branch `${{ github.event.workflow_run.head_branch }}`.

            **CI Run:** [#${{ github.event.workflow_run.run_number }}](${{ github.event.workflow_run.html_url }})

            - Lint: ✅ passed
            - Typecheck: ✅ passed
            - Build: ✅ passed

            Please review and squash-merge when ready.
          github_token: ${{ secrets.GITHUB_TOKEN }}
